---
title: "좌충우돌 우분투 패키지 업데이트"
date: "2021-04-05 00:26:46"
description: "좌충우돌 우분투 패키지 업데이트 & 우분투 패키지 크롤링"
category: "experience"
---

### 문제의 시작

Ubuntu의 패키지를 업데이트를 해야했습니다. 찾아보니 apt 툴을 이용하면 되는것 같았습니다. 
굉장히 쉬워보였죠. 하지만 보면서 저의 상황과는 맞지 않는다는걸 깨달았습니다.

제가 패키지를 업데이트할 서버는 외부망과 연결이 되어 있지 않았습니다. 오직 내부망으로 접근이 가능했죠.
앞으로 벌어질 모든 문제의 시작이었습니다.

일단 저는 우분투를 제대로 다루지 못합니다. 제가 어떤 행동을 했을때 따라오는 리스크에 대해서 파악이 되질 않았죠.
다행히 문제가 생겼던 서버가 당장 이용자에게 영향이 끼치지 않았으니 망정이지. 아니었다면 끔찍한 일이 되었을 겁니다.

정말이지 모르는 것에 대해 무서움 없이 달려드는 저의 성격의 단점이 명백하게 들어났던 경험이었습니다. ~~그래도 좋은 점이 더 많다고 생각합니다.~~

### 문제의 원인

우분투에 패키지를 설치하기 위한 툴로 apt와 dpkg가 있습니다. 
apt와 dpkg 모두 우분투의 패키지를 관리하기 위한 툴이지만 dpkg는 apt에 비해 낮은 단계에서 패키지를 관리합니다.
apt 내부적으로 dpkg를 사용하여 패키를 설치하게 되죠. **또한 dpkg는 패키지 간의 의존성을 보지 않습니다.** apt와 dpkg의 결정적인 차이입니다.

저는 dpkg를 통해 패키지를 설치했었습니다. 의존성을 무시한채 패키지를 설치한 결과 패키지간의 의존성이 꼬여 SSH 접속이 안되는 상황이 펼쳐졌습니다. 
서버실에 왔다 갔다 하며 SSH 접속을 해결했더니 이후엔 가장 기본적인 명령어(ls, mount 등)조차 안되는 상황까지 일어났었습니다.

### 문제해결

문제를 해결하는 방법은 뚜렷합니다. 생각없이 설치했던 패키지를 롤백하거나 해당 패키지가 필요한 의존성을 모두 채워주면 해결입니다.
저는 롤백대신 필요한 의존성을 모두 채워주기로 했습니다. 그래서 [https://packages.ubuntu.com/](https://packages.ubuntu.com/) 이곳에 들어가 필요한 패키지를 모두 다운로드 받았죠.

### 착오
 
저는 다운로드 받은 패키지들을 dpkg를 통해 하나하나 설치해나갔습니다. 하지만 이 방법은 잘못되었습니다.
다행인지 불행인지 SSH 접속이 안되는 상황을 해결할 때에는 괜찮았습니다만 문제가 발생합니다.

우분투 패키지에는 서로가 서로를 의존하는 경우가 있습니다. A가 B를, B가 A를 말이죠.

SSH 접속이 해결되고 나서 제가 업데이트하려고 했던 패키지를 똑같은 방법으로 설치를 진행했습니다.
이때 조금 찜찜한 기분을 제대로 알아보고 진행했어야 했습니다.
**괜찮겠지**~~뭐가 괜찮아 이 자식아~~라는 생각으로 A부터 설치를 진행한 저였습니다만 그 순간 의존성이 꼬였습니다.

이때부터 상당히 심각한 상황이 되어버립니다. 기본 명령어 조차 안되는 심각한 문제가 생겨버린 겁니다.
ls, mount 그리고 ~~빌어먹을~~ 경험상 현재 접속하고 있는 SSH가 끊기면 SSH도 안된거라는걸 알았죠.
**아마도 이 상황까지 오게 되면 우분투 설치 디스크를 꽂아 재설치 혹은 복구를 진행해야 맞을겁니다.**

### 시행

그렇다고 이렇다할 노력도 안하고 디스크를 꽂는건 아니다 싶어 검색하고 또 검색했습니다.(이때 이 글에 쓴 내용 대부분을 알게 됩니다.)
검색 중에 알아낸 사실 중 하나가 **deb 파일 안 lib 폴더에 들어있는 ~.so 파일이 패키지의 내용을 담은 파일**이라는 내용이었습니다. 

그리고 재밌게도 저는 현재 dpkg가 인식하고 있는 버전은 아니지만 그 상위 버전의 deb 파일을 가지고 있었습니다. 이제부턴 밑져야 본전입니다.
**상위 버전의 so 파일을 하위 버전의 이름을 바꿔서 넣고 실행해보자.** 상위버전이니까 가능할지도 몰라라는 생각이었습니다.

**근데 정말 놀랍게도 먹혀들더군요.**#:thumbsup: 이게 되? ~~내적 환호성 질렀습니다. 정말~~

이제 다시 침착하게 패키지를 업데이트하면 되겠다고 생각했습니다. 하지만 dpkg로 하는 방식은 안 됩니다. apt를 사용하여 의존성을 확인해줘야죠.
```
apt-get install ~~/*.deb
```
이렇게 명령을 내리면 apt가 알아서 설치할 deb 파일들의 의존 관계를 파악하며 설치를 진행합니다. ~~처음부터 이렇게...~~ 
하지만 다시 문제가 생깁니다. 부족한 패키지가 있었습니다. 제가 모두 다운로드 한다고 했지만 빼먹은게 있었던 것이죠. 그리고 SFTP는 아직 연결이 되질 않았습니다.

그렇게 다시 패키지 업데이트가 미궁으로 빠질려는 순간 저의 머릿속에서 한가지 아이디어가 떠오릅니다. "SSH 접속이 되어 있는데 왜 파일 옮기기는 안되지? SSH로는 못 옮기나?"
그럴리가 없습니다. 검색해보니 당연하다는듯 scp 명령어가 존재하더군요.

```
scp <source_path><username>@<ip>:<dest_path>
```

scp를 이용한 파일 옮기기는 쉽게 성공했습니다. 하지만 부족한 부분을 다시 손을 다운로드 받긴 했지만 찝찝하더군요.
그래서 우분투 패키지 사이트를 크롤링해서 의존이 필요한 패키지들 모두를 다운로드 받는 툴을 하나 만들기로 했습니다.

Node로 만든 이 툴([https://github.com/wesbin/UbuntuPackageCrawling](https://github.com/wesbin/UbuntuPackageCrawling))은 [https://packages.ubuntu.com/](https://packages.ubuntu.com/) 이곳에서 원하는 패키지가 의존하는 패키지를 재귀적으로 모두 다운로드 하게 됩니다.

그렇게 만든 툴로 모든 패키지를 다운로드, scp로 업로드, apt 명령어를 사용하여 일괄 설치를 성공했습니다.

### 마치며

이제까지 우분투 초보가 좌충우돌로 패키지를 업데이트했던 경험에 대해서 말씀드렸습니다. 지금 생각해도 저런 임기응변이 통했던 것 행운이었다고 생각합니다.
서버를 다룰때 내가 하고 있는 것에 대한 리스크를 파악하는 일이 얼마나 중요한지 깨닫게 되는 사건이었습니다. 이러한 경험이 여러분들에게 조금이나마 도움이 되었으면 좋겠습니다.

감사합니다.
