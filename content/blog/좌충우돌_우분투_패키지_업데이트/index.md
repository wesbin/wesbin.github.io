---
title: "우분투 패키지 업데이트"
date: "2021-04-17T22:40:32.169Z"
description: "우분투 패키지 업데이트"
category: "experience"
---

안녕하세요. 위성빈입니다. 오늘은 창피한 얘기를 해볼까 합니다. 꽤 시간이 흘렀는데도 생각해보면 정말 가관이네요.

### 문제의 시작

일단 저는 Ubuntu를 제대로 다루지 못합니다. 제가 어떤 행동을 했을때 따라오는 리스크에 대해서 파악이 되질 않았죠. 그런 상황에서 저는 Ubuntu 패키지를 업데이트 해야했습니다. 생각보다 간단해보였습니다. apt 툴을 이용하면 커맨드 한 줄이면 끝나는 것처럼 보였죠. 언제나 그런 느낌인건 기분 탓이겠지만 이 방식은 제 상황과 맞지 않는다는걸 깨달았습니다.

제가 패키지를 업데이트할 서버는 외부망과 연결이 되어 있지 않았습니다. 인터넷에 있는 대부분의 내용은 apt를 이용한 방법은 외부망과의 연결이 필수였죠.

지금 생각해보면 여기서 멈춰 물어보거나 보다 깊게 조사를 했어야 했습니다. 모르는 것에 대해 무서움 없이 달려드는게 제 성격의 장점이라고 생각하고 있지만 이번만큼은 그 뒷면이 명백하게 들어났습니다.

우분투에 패키지를 설치하기 위한 툴로 apt와 dpkg가 있습니다. dpkg는 apt에 비해 낮은 단계에서 패키지를 관리하고 결과적으로 apt 내부적으로 dpkg를 사용하죠. 그 말인즉슨 dpkg는 제한이 없는 대신 위험도가 높다는 걸 의미했습니다. 하지만 저는 이 시점에서 그 위험에 대해서 눈치를 채지 못하죠.

그렇게 저는 dpkg를 이용해 패키지를 설치하기로 하고 Ubuntu 패키지를 [Ubuntu packages](https://packages.ubuntu.com/)에서 다운로드 받아 설치하기 시작하죠. 그리고 제가 눈치 채지 못했던 dpkg의 위험성이 드러나게 됩니다. **dpkg는 패키지를 설치할 때 패키지 간의 의존성을 보지 않습니다.** 이런 사실을 모른채 작업을 진행했던 Ubuntu 서버의 패키지들의 의존성이 꼬이기 시작했고, 기존에 잘 되던 패키지들도 안되기 시작했습니다.

결과적으론 서버로의 원격 접속을 도와주던 SSH 명령어가 먹통이 되어버립니다. 직접 서버에 접속해야하는 상황이 펼쳐졌고. '망했다'라는 말이 절로 나오더군요.

### 착오

이 때 제가 생각했던 문제 해결 방법은 두 가지였습니다. 생각없이 설치했던 패키지를 롤백하거나 해당 패키지가 필요한 의존성을 모두 채워주는 것. 저는 롤백 대신 필요한 의존성을 모두 채워주기로 합니다. 시간이 흘러 지금 생각해보면 롤백을 하는게 더 간단한 방법이었을텐데 왜 그런 선택을 했는지 의문이 들긴 합니다. 어쨋든 저는 필요한 패키지를 모두 다운로드 받아 다시 설치를 시작했습니다. 하나의 패키지를 설치하고 다음 패키지를 설치하는 방식으로 말이죠.

하지만 이 방식에는 큰 오류가 있었습니다. 우분투 패키지에는 서로가 서로를 의존하는 경우가 있습니다. A가 B를, B가 A를 의존하는 형태죠. 그런 사실을 모른채 설치를 진행하던 어느 시점에 심각한 상황이 발생해버립니다. ls, mount와 같은 아주 기본적인 명령어 조차 안되는 심각한 문제가 생겨버린 겁니다.

한번 더 망했습니다.

아마도 이 상황까지 오게되면 우분투 설치 디스크를 꽂아 재설치나 복구를 진행하는게 맞을겁니다. 저도 그렇게 생각했고요. 그래도... 저는 그래도 뭔가 있지 않을까 계속 뒤졌습니다. 이때 제가 뭐를 놓쳤고 뭐를 잘못했는지 대부분 알게 되죠. 

이를테면 이런 사실들입니다. Ubuntu 패키지 업데이트를 위해서 다운로드 받았던 deb 파일은 일종의 압축 파일이고, 그 안에 있는 lib 폴더에 들어가있는 ~.so 파일이 해당 패키지의 내용을 담은 파일. 결국 dpkg로 패키지를 설치한다는 것은 deb 파일의 압출을 풀어 so 파일을 '/usr/lib' 위치에 옮겨두는 것.

하지만 그럼 뭐합니까. 할 수 있는게 없는데. 이런 정보들을 얻어갈수록 절망감만 쌓여가더군요.

그래도! 제 머리는 아주 열심히 돌아가줬습니다. 끊임없이 '없나?', '진짜?'를 스스로에게 되물으며 손을 놓지 않았습니다. 이때 상황은 ls, mount 등의 명령어가 실행되는 데 필요한 패키지. 이를테면 ~~그 패키지의 이름이 기억나지 않는군요~~ A의 1.0 버전이 필요했습니다. 이게 설치되어서 기본 명령어들이 동작한다면 다시 패키지를 설치할 수 있게 되는 것이죠. 

그런 상황에서 저는 필요했던 A 패키지의 1.0 버전은 아니지만 그보다 높은 예를 들면 1.5 버전의 A 패키지가 서버 안에 있는걸 보게 됩니다. 패키지를 설치하기 위해 넣어둔 것이었죠. 그리고 이걸 보자마자 저는 재밌는 생각이 하나 떠오릅니다.

> "dpkg로 설치는 안되. 근데 어차피 deb 파일 안에 있는 so를 내가 수동으로 옮기면 되잖아. 그리고 1.0 버전은 아니지만 상위 버전이니까 비슷하지 않겠어? 애초에 아주 기본적인 명령어니까 더욱 그러지 않을까? so 파일 이름을 1.0 버전으로 바꾸고 해보자."

라는 식이죠. 그럴 듯 해보이지 않습니까? 적어도 저는 그렇게 생각했습니다. 그리고

"이게 돼? 아니... 이게 된다고?"

진짜 자리에서 박차고 일어났습니다. 혼자가 아닌지라 내적 환호성 진짜 크게 질렀습니다. 그리곤 심호흡을 하고 침착하게 패키지를 업데이트하면 되겠다고 생각했습니다. 하지만 이전 방식으로는 절대 안 됩니다. 새로운 방법을 찾아야했죠.

### 해결

```
apt-get install ~~/*.deb
```

착오에 빠져 수많은 검색을 하던 때에 찾았던 내용이었습니다. 이렇게 명령을 내리면 apt가 알아서 설치할 deb 파일들의 의존 관계를 파악하며 안전하게 설치를 해준다는 것이었습니다. 일단 한숨. 후...

이번에는 된다! 라고 자신있게 명령어를 쳤지만 안 됐습니다. 문제가 터지진 않았습니다. apt가 설치하려면 이거이거 패키지가 필요해라고 친절하게 알려주더라고요. 다시 한숨. 후...

보니 제가 모두 다운로드 한다고 했지만 워낙 많은지라 빼먹은게 있었던 것이었죠. 그리고 여기서 부족한 부분을 다시 수작업으로 다운로드 받을 수도 있었지만 툴을 하나 만들기로 합니다. 

이름하여 [우분투 패키지 스크래핑](https://github.com/wesbin/ubuntu-package-scraping). 

패키지 설치에 필요한 의존 패키지들을 모두 일괄로 다운로드하는 툴입니다. 툴을 만들고 패키지를 다운로드 받았습니다. 다운받은 패키지를 서버에 업로드하려니 또 문제가 있었습니다.

SSH는 되고 있었는데 SFTP 연결이 안 되었습니다. 이전과 마찬가지로 패키지 의존 문제였죠. mount 명령어가 되니 서버에 직접 접근해도 됐었으나 그러기 위해선 인프라팀을 거쳐 가야 했습니다. 그래서 일단은 다시 고민에 빠지죠. 뒤가 있으니 정말 마음편한 고민이었습니다. 그래서인가 금방 해결 방법을 찾을 수 있었습니다.

SSH만 연결되어 있으면 파일을 옮길 수 있는 scp 명령어라는게 있었습니다.

```
scp <source_path><username>@<ip>:<dest_path>
```

그렇게 scp를 이용해 파일을 옮기고 이 사단은 대단원을 맞이하게 됩니다. 

apt-get install ~~/*.deb

끝!

### 마치며

전체로 보자면 이틀에 걸쳐 일어난 일이었습니다만 두 번째 날은 패키지 다운로드 툴을 만들기 위한 시간이었고, 사건들은 모두 첫째 날 벌어진 일이었죠. 정말 지옥 같은 하루였습니다. 그래도 해결이 되었으니 불행 중 다행이라고 해야 할지... 어쨋든 저런 임기응변이 통했던 건 분명 행운이겠죠.

이 사건이 있고 나서는 서버에 대해 어떤 작업을 하던 한 번 더 찾아보고, 한 번 더 확인하는 습관이 생겼습니다. 이 글을 통해 여러분들은 서버를 다루다 이 지경이 되는 일이 없으면 하네요.

그럼 마칩니다. 글을 읽어주셔서 감사합니다.